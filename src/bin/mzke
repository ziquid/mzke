#!/bin/bash
# mzke -- make for muziq

function _mzke_find_mzkefile() {

  STARTDIR=$(pwd -P)
  cd "$STARTDIR"

  while true; do

    NUMSLASHES=$(pwd -P | tr -d -c / | wc -c)
    if [ "$NUMSLASHES" -le 2 ]; then
      break
    fi

    cd ..
    if [ -r Mzkefile ]; then
      MAKEFILE="$(pwd -P)"/Mzkefile
      break
    fi

  done

  cd "$STARTDIR"
  echo $MAKEFILE
}

# Process -C flag first, before any file searching
if [ "$1" == -C ]; then
  cd "$2"
  [ $? -ne 0 ] && echo Error: could not cd to "$2" >&2 && exit 1
  shift 2
fi

if [ "$1" == -f ]; then
  MAKEFILE="$2"
  shift 2
elif [ -r Mzkefile ]; then
  MAKEFILE=Mzkefile
elif [ -r Makefile ]; then
  MAKEFILE=Makefile
else
  # Search parent directories if no local M.kefile found
  MAKEFILE=$(_mzke_find_mzkefile)
  if [ -n "$MAKEFILE" ]; then
    DIRNAME=$(dirname "$MAKEFILE")
    SUBDIR="-C \"$DIRNAME\""
    MAKEFILE=$(basename "$MAKEFILE")
  fi
fi

[ "$1" == -n ] && OPTS=-n && shift
[ "$1" == -s ] && OPTS=-s && NO_PRINT_BANNER=1 && shift

TARGET=all

[ -n "$1" ] && TARGET="$1" && shift

VARS="IS_MZKE=YES MAKE_USER_COMMAND=mzke"
ARGS=

if [ $# -gt 0 ]; then
  # Use printf to properly quote each argument
  quoted_args=
  for arg in "$@"; do
    quoted_args="${quoted_args} $(printf %q "$arg")"
  done
  ARGS_QUOTED="ARGS=\"${quoted_args# }\""  # Remove leading space
  ARGS=ARGS="$@"
fi

# Rule 1: if no makefile and target is "prep", use Makefile
# Makefile.song.common

if [ "$TARGET" == prep -a -z "$MAKEFILE" ]; then
  MAKEFILE=/usr/local/share/muziq/Makefile.song.common
fi

[ -z "$MAKEFILE" ] && echo Fatal error: No M.kefile found >&2 && exit 1

# Execute make
[ "$NO_PRINT_BANNER" = 1 ] || echo make -f $MAKEFILE $SUBDIR $OPTS $VARS $ARGS_QUOTED $TARGET
eval make -f \"$MAKEFILE\" $SUBDIR $OPTS $VARS $ARGS_QUOTED $TARGET
